{% extends "base.html" %}
{% block titleTag -%}
<title>{{ _("Feeds") }} - KindleEar</title>
{% endblock -%}

{% block bodytag -%}
<body class="my-rss">
{% endblock -%}

{% block content -%}
<div class="main">
  <legend><h3>{{_("Custom Rss")}}</legend>
  <div class="box-list">
    <div class="book box pure-form pure-form-aligned">
      <div class="pure-control-group titleRow pure-g">
        <div class="pure-u-3-5 pure-u-sm-3-4 pure-u-md-5-6">
          <input type="text" name="rss_title" id="title_to_add" class="pure-u-23-24 pure-input-rounded" placeholder="{{ _('Title')}}"
            {% if title_to_add %}value="{{title_to_add}}"{% endif %}/>
        </div>
        <div class="pure-u-2-5 pure-u-sm-1-4 pure-u-md-1-6">
          <div style="padding:.5em;">
            <input type="checkbox" name="fulltext" id="isfulltext" />
            <img alt="{{ _('Fulltext') }}" src="static/fulltext.gif" border="0" />
          </div>
        </div>
      </div>
      <div class="summaryRow">
        <input type="text" name="url" id="url_to_add" class="pure-input-1 pure-input-rounded" placeholder="URL"
        {% if url_to_add %}value="{{url_to_add}}"{% endif %}/>
      </div>
      <div class="cornerControls">
        <button onclick="AddCustomRss();return false;" class="actionButton add">{{_("Add")}}</button>
      </div>
      {% if tips -%}
        <div class="notice-box">{{tips|safe}}</div>
      {% endif -%}
    </div>

    <div id="divMyCustomRss">
      <!-- 由脚本在这里填充数据 -->
    </div>
  </div>
  
  <legend><h3>{{ _("Subscribed") }}</h3></legend>
  <div id="mysubscribed" class="box-list">
    <!-- 由脚本在这里填充数据 -->
  </div>

  <legend><h3>{{ _("Library") }} </h3></legend>
  <div class="pure-g box-list noborder">
    <div class="pure-u-1-3 width1_3 pure-form"><select class="pure-input-rounded width100" id="language_pick">
    </select></div>
    <div class="pure-u-1-6">
      <div class="upload-recipe">
        <button class="upload-recipe-btn" title="{{_('Upload your custom recipe')}}"onclick="OpenUploadRecipeDialog()"><i class="iconfont icon-upload"></i></button>
      </div>
    </div>
    <div class="pure-u-3-6">
      <div class="pure-form">
        <input type="text" name="search" id="search_recipe" class="pure-input-rounded" placeholder="{{ _('Search')}}" />
      </div>
    </div>
  </div>
  <div id="all_recipes" class="box-list">
    <!-- 由脚本在这里填充数据 -->
  </div>

  <legend><h3>{{ _("Bookmarklet") }}</h3></legend>
  <div id="bookmarklet" class="box-list">
    <div class="book box" id="bookmarklet_content">
      <a class="actionButton" target="_blank" href="javascript:location.href='{{subscribe_url}}?title_to_add='+encodeURIComponent(document.title)+'&url_to_add='+encodeURIComponent(window.location.href);" onclick="return false;">
        {{_("Add to KindleEar")}}
      </a>
      <div style="padding-top:10px;text-align:center;">
        <small>- {{_("Drag and drop this link to your bookmarks")}} -</small>
      </div>
    </div>

  </div>
</div>
{% endblock -%}

{% block js -%}
<script type="text/javascript">
var my_custom_rss_list = {{my_custom_rss|safe}};
var my_uploaded_recipes = {{my_uploaded_recipes|safe}};
var my_booked_recipes = {{my_booked_recipes|safe}};

// return a appspotmail url for bookmarklet
function appspotmailUrl(){
  var parser = document.createElement('a');
  parser.href = "{{subscribe_url}}";

  var host = parser.hostname;
  var length = host.length;
  if ((length > 12) && host.substr(length - 12, 12) == '.appspot.com'){
    {% if session.get('role') == 'admin' -%}
    var addr = "read@";
    {% else -%}
    var addr = "{{user.name}}__read@";
    {% endif -%}
    return addr + host.substr(0, length - 12) + '.appspotmail.com';
  }else{
    return "";
  }
}
function insertBookmarkletGmailThis(){
  var mailUrl = appspotmailUrl();
  if (mailUrl == ""){
    return;
  }

  var parent = document.getElementById('bookmarklet_content');
  var theFirstChild = parent.firstChild;
  var newElement = document.createElement("a");
  newElement.className = "actionButton";
  var href = "javascript:(function(){popw='';Q='';d=document;w=window;if(d.selection){Q=d.selection.createRange().text;}else if(w.getSelection){Q=w.getSelection();}else if(d.getSelection){Q=d.getSelection();}popw=w.open('http://mail.google.com/mail/s?view=cm&fs=1&tf=1&to=" + mailUrl +
      "&su='+encodeURIComponent(d.title)+'&body='+encodeURIComponent(Q)+escape('%5Cn%5Cn')+encodeURIComponent(d.location)+'&zx=RANDOMCRAP&shva=1&disablechatbrowsercheck=1&ui=1','gmailForm','scrollbars=yes,width=550,height=400,top=100,left=75,status=no,resizable=yes');if(!d.all)setTimeout(function(){popw.focus();},50);})();";
  newElement.setAttribute("href", href);
  newElement.setAttribute("onclick", "return false;");
  newElement.textContent = "{{_('Read with Kindle')}}";
  parent.insertBefore(newElement, theFirstChild);
}
</script>
<script type="text/javascript" src="/static/base.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
  FetchBuiltinRecipesXml();
  PopulateMyCustomRss(); //填充订阅区段
  PopulateMySubscribed();
  RegisterHideHambClick();
  insertBookmarkletGmailThis();
});
</script>
{% endblock -%}
